---
# yaml-language-server: $schema=https://raw.githubusercontent.com/SchemaStore/schemastore/refs/heads/master/src/schemas/json/github-workflow.json
name: Workflow - Pull Request Main (merge)

on:
  workflow_dispatch:
  merge_group:

jobs:
  # ========================================================================= #
  #                              NIGHTLY RELEASE                              #
  # ========================================================================= #

  build-nightly-and-publish-madara:
    uses: ./.github/workflows/task-build-nightly-and-publish.yml
    with:
      image-name: madara
      image-file: ./madara/Dockerfile
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    secrets: inherit

  # test-hive:
  #   needs: [build-nightly]
  #   uses: ./.github/workflows/task-test-hive.yml
  #   with:
  #     nightly-sha: ${{ needs.build-nightly.outputs.nightly-sha }}
  #   secrets: inherit

  build-nightly-and-publish-orchestrator:
    uses: ./.github/workflows/task-build-nightly-and-publish.yml
    with:
      image-name: orchestrator
      image-file: ./orchestrator/Dockerfile
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    secrets: inherit

  build-nightly-and-publish-bootstrapper:
    uses: ./.github/workflows/task-build-nightly-and-publish.yml
    with:
      image-name: bootstrapper
      image-file: ./bootstrapper/Dockerfile
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    secrets: inherit

  # ========================================================================= #
  #                                MERGE QUEUE                                #
  # ========================================================================= #

  # Run coverage tests (Madara)
  test-madara:
    uses: ./.github/workflows/task-do-nothing-test-madara.yml

  # Run coverage tests (Orchestrator)
  test-orchestrator:
    uses: ./.github/workflows/task-do-nothing-test-orchestrator.yml

  # Run e2e tests (Orchestrator)
  # e2e-orchestrator:
  #   uses: ./.github/workflows/task-do-nothing-e2e-orchestrator.yml

  # Run coverage tests (Bootstrapper)
  test-bootstrapper:
    uses: ./.github/workflows/task-do-nothing-test-bootstrapper.yml

  # Run JavaScript tests
  test-js:
    uses: ./.github/workflows/task-do-nothing-test-js.yml

  # Run CLI tests
  test-cli:
    uses: ./.github/workflows/task-do-nothing-test-cli.yml

  # ========================================================================= #
  #                                E2E Test                                   #
  # ========================================================================= #

  # Build Madara binary
  build-madara:
    needs: [lint-code-style]
    uses: ./.github/workflows/task-build-madara.yml
    secrets: inherit

  # Build Orchestrator binary
  build-orchestrator:
    needs: lint-code-style
    uses: ./.github/workflows/task-build-orchestrator.yml
    secrets: inherit

  # Build Bootstrapper binary
  build-bootstrapper:
    needs: lint-code-style
    uses: ./.github/workflows/task-build-bootstrapper.yml
    secrets: inherit

  # End-to-end tests
  test-end-to-end:
    needs: [build-madara, build-orchestrator, build-bootstrapper]
    uses: ./.github/workflows/task-test-end-to-end.yml
    with:
      madara-binary-hash: ${{ needs.build-madara.outputs.madara-binary-hash }}
      orchestrator-binary-hash: ${{ needs.build-orchestrator.outputs.orchestrator-binary-hash }}
      bootstrapper-binary-hash: ${{ needs.build-bootstrapper.outputs.bootstrapper-binary-hash }}
      cairo-artifacts-hash: ${{ needs.build-madara.outputs.cairo-artifacts-hash }}
    secrets: inherit
