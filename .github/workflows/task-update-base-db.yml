# Update Base DB Fixture
#
# This workflow automatically updates the base DB fixture when base_version
# changes in .db-versions.yml. It:
# 1. Builds madara from main
# 2. Syncs a small number of blocks from Sepolia
# 3. Packages the DB and uploads to GitHub releases
#
# The uploaded DB is used by migration tests to validate migrations work correctly.

name: Task - Update Base DB Fixture

on:
  push:
    branches: [main]
    paths:
      - '.db-versions.yml'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version unchanged'
        required: false
        default: 'false'
        type: boolean
      blocks_to_sync:
        description: 'Number of blocks to sync'
        required: false
        default: '50'
        type: string

env:
  BLOCKS_TO_SYNC: ${{ inputs.blocks_to_sync || '50' }}

jobs:
  check-version-change:
    name: Check if base_version changed
    runs-on: ubuntu-latest
    outputs:
      should_update: ${{ steps.check.outputs.should_update }}
      base_version: ${{ steps.check.outputs.base_version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to compare

      - name: Check for base_version change
        id: check
        run: |
          # Get current base_version
          CURRENT_VERSION=$(grep 'base_version:' .db-versions.yml | awk '{print $2}')
          echo "Current base_version: $CURRENT_VERSION"
          echo "base_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Check if force update
          if [ "${{ inputs.force_update }}" = "true" ]; then
            echo "Force update requested"
            echo "should_update=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get previous base_version (if exists)
          if git show HEAD~1:.db-versions.yml > /tmp/old-versions.yml 2>/dev/null; then
            OLD_VERSION=$(grep 'base_version:' /tmp/old-versions.yml | awk '{print $2}')
            echo "Previous base_version: $OLD_VERSION"
            
            if [ "$CURRENT_VERSION" != "$OLD_VERSION" ]; then
              echo "base_version changed from $OLD_VERSION to $CURRENT_VERSION"
              echo "should_update=true" >> $GITHUB_OUTPUT
            else
              echo "base_version unchanged"
              echo "should_update=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No previous version file, assuming new"
            echo "should_update=true" >> $GITHUB_OUTPUT
          fi

  update-base-db:
    name: Create and upload base DB
    needs: check-version-change
    if: needs.check-version-change.outputs.should_update == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write  # Needed to create releases
    
    env:
      BASE_VERSION: ${{ needs.check-version-change.outputs.base_version }}
      DB_PATH: /tmp/madara-base-db
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: madara

      - name: Build madara
        working-directory: madara
        run: |
          echo "ðŸ”¨ Building madara..."
          cargo build --release -p madara

      - name: Sync blocks to create base DB
        working-directory: madara
        run: |
          echo "ðŸ“¦ Creating base DB by syncing ${{ env.BLOCKS_TO_SYNC }} blocks..."
          
          mkdir -p ${{ env.DB_PATH }}
          
          # Start madara and sync blocks
          timeout 600 ./target/release/madara \
            --name base-db-generator \
            --base-path ${{ env.DB_PATH }} \
            --network sepolia \
            --full \
            --no-l1-sync \
            --sync-stop-at ${{ env.BLOCKS_TO_SYNC }} || true
          
          # Verify DB was created
          if [ ! -f "${{ env.DB_PATH }}/.db-version" ]; then
            echo "âŒ DB version file not created"
            exit 1
          fi
          
          DB_VERSION=$(cat ${{ env.DB_PATH }}/.db-version)
          echo "âœ… Base DB created with version: $DB_VERSION"
          
          # Verify version matches expected
          if [ "$DB_VERSION" != "${{ env.BASE_VERSION }}" ]; then
            echo "âš ï¸ Warning: DB version ($DB_VERSION) differs from base_version (${{ env.BASE_VERSION }})"
          fi

      - name: Package base DB
        run: |
          echo "ðŸ“¦ Packaging base DB..."
          
          cd ${{ env.DB_PATH }}
          tar -czf /tmp/base-db-v${{ env.BASE_VERSION }}-sepolia.tar.gz .
          
          # Show package info
          ls -lh /tmp/base-db-v${{ env.BASE_VERSION }}-sepolia.tar.gz
          echo "âœ… Package created"

      - name: Create or update release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: db-fixtures-v${{ env.BASE_VERSION }}
          name: "DB Fixtures v${{ env.BASE_VERSION }}"
          body: |
            ## Base DB Fixture for Migration Testing
            
            This release contains a RocksDB database synced to ${{ env.BLOCKS_TO_SYNC }} blocks from Sepolia testnet.
            
            **DB Version:** ${{ env.BASE_VERSION }}
            **Network:** Sepolia
            **Blocks:** ${{ env.BLOCKS_TO_SYNC }}
            **Created:** ${{ github.event.head_commit.timestamp || github.event.repository.updated_at }}
            
            ### Usage
            
            This fixture is automatically used by the migration test workflow.
            To use manually:
            
            ```bash
            curl -L "https://github.com/${{ github.repository }}/releases/download/db-fixtures-v${{ env.BASE_VERSION }}/base-db-v${{ env.BASE_VERSION }}-sepolia.tar.gz" -o base-db.tar.gz
            tar -xzf base-db.tar.gz -C /path/to/madara/base-path
            ```
          files: /tmp/base-db-v${{ env.BASE_VERSION }}-sepolia.tar.gz
          draft: false
          prerelease: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Base DB Update Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ env.BASE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Blocks:** ${{ env.BLOCKS_TO_SYNC }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release:** [db-fixtures-v${{ env.BASE_VERSION }}](https://github.com/${{ github.repository }}/releases/tag/db-fixtures-v${{ env.BASE_VERSION }})" >> $GITHUB_STEP_SUMMARY

