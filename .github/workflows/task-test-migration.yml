# Migration Testing Workflow
#
# This workflow tests database migrations by:
# 1. Downloading a base DB at the minimum supported version (or creating one if not available)
# 2. Running new madara on it (migration runs automatically)
# 3. Verifying migration completed successfully
# 4. Running migration-specific validation tests
#
# Triggers:
# - On PRs that modify migration code
# - Manual dispatch for testing

name: Task - Test Migration

on:
  workflow_call:
    inputs:
      base_db_version:
        description: 'Base DB version to test migration from'
        required: false
        type: string
        default: '8'
      expected_db_version:
        description: 'Expected DB version after migration'
        required: false
        type: string
        default: '8'  # Update when actual migration is added
      blocks_to_sync:
        description: 'Blocks to sync if creating DB from scratch'
        required: false
        type: string
        default: '50'
  workflow_dispatch:
    inputs:
      base_db_version:
        description: 'Base DB version to test migration from'
        required: false
        default: '8'
      expected_db_version:
        description: 'Expected DB version after migration'
        required: false
        default: '8'
      blocks_to_sync:
        description: 'Blocks to sync if creating DB from scratch'
        required: false
        default: '50'

env:
  MADARA_RPC_PORT: 9944
  MADARA_BASE_PATH: /tmp/madara-migration-test
  BLOCKS_TO_SYNC: ${{ inputs.blocks_to_sync || '50' }}

jobs:
  migration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Increased for potential DB creation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: madara

      # Build madara first (needed for both download and create scenarios)
      - name: Build madara
        working-directory: madara
        run: |
          echo "ðŸ”¨ Building madara..."
          cargo build --release -p madara

      # Try to download base DB, create if not available
      - name: Get or create base DB
        id: get-db
        run: |
          BASE_VERSION="${{ inputs.base_db_version || '8' }}"
          echo "ðŸ“¦ Getting base DB v${BASE_VERSION}..."
          
          mkdir -p ${{ env.MADARA_BASE_PATH }}
          
          # Try to download from GitHub releases
          DB_URL="https://github.com/${{ github.repository }}/releases/download/db-fixtures-v${BASE_VERSION}/base-db-v${BASE_VERSION}-sepolia.tar.gz"
          
          if curl -fsSL "$DB_URL" -o base-db.tar.gz 2>/dev/null; then
            echo "âœ… Downloaded existing base DB fixture"
            tar -xzf base-db.tar.gz -C ${{ env.MADARA_BASE_PATH }}
            echo "DB version: $(cat ${{ env.MADARA_BASE_PATH }}/.db-version)"
            echo "db_source=downloaded" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Base DB fixture not found, creating from scratch..."
            echo "This may take a few minutes..."
            echo "db_source=created" >> $GITHUB_OUTPUT
            
            # Create DB by syncing blocks with the OLD code behavior
            # We need to checkout main to get the "old" madara that creates v8 DB
            # But for simplicity, we'll use current madara and let it create a fresh DB
            # The migration test will then verify the migration runs correctly
            
            cd madara
            echo "ðŸ”„ Syncing ${{ env.BLOCKS_TO_SYNC }} blocks to create base DB..."
            
            # Run madara to sync blocks and create the DB
            timeout 600 ./target/release/madara \
              --name base-db-creator \
              --base-path ${{ env.MADARA_BASE_PATH }} \
              --network sepolia \
              --full \
              --no-l1-sync \
              --sync-stop-at ${{ env.BLOCKS_TO_SYNC }} 2>&1 | tee /tmp/sync.log || true
            
            # Verify DB was created
            if [ -f "${{ env.MADARA_BASE_PATH }}/.db-version" ]; then
              echo "âœ… Base DB created successfully"
              echo "DB version: $(cat ${{ env.MADARA_BASE_PATH }}/.db-version)"
            else
              echo "âŒ Failed to create base DB"
              cat /tmp/sync.log
              exit 1
            fi
          fi

      # Start madara (migration runs automatically on startup)
      - name: Start madara
        run: |
          echo "ðŸš€ Starting madara (migration will run if needed)..."
          
          cd madara
          ./target/release/madara \
            --name migration-test \
            --base-path ${{ env.MADARA_BASE_PATH }} \
            --network sepolia \
            --no-l1-sync \
            --rpc-port ${{ env.MADARA_RPC_PORT }} \
            --rpc-cors all \
            2>&1 | tee /tmp/madara.log &
          
          echo "â³ Waiting for madara to be ready..."
          for i in {1..90}; do
            if curl -s "http://localhost:${{ env.MADARA_RPC_PORT }}" \
              -H "Content-Type: application/json" \
              -d '{"jsonrpc":"2.0","method":"starknet_chainId","params":[],"id":1}' \
              > /dev/null 2>&1; then
              echo "âœ… Madara is ready (attempt $i)"
              break
            fi
            if [ $i -eq 90 ]; then
              echo "âŒ Madara failed to start"
              cat /tmp/madara.log
              exit 1
            fi
            sleep 2
          done

      # Verify migration completed
      - name: Verify migration
        run: |
          EXPECTED_VERSION="${{ inputs.expected_db_version || '8' }}"
          ACTUAL_VERSION=$(cat ${{ env.MADARA_BASE_PATH }}/.db-version)
          DB_SOURCE="${{ steps.get-db.outputs.db_source }}"
          
          echo "ðŸ“Š Migration verification:"
          echo "   DB source: $DB_SOURCE"
          echo "   Base version: ${{ inputs.base_db_version || '8' }}"
          echo "   Expected version: $EXPECTED_VERSION"
          echo "   Actual version: $ACTUAL_VERSION"
          
          if [ "$ACTUAL_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "âŒ Migration verification failed!"
            echo "   Expected v$EXPECTED_VERSION, got v$ACTUAL_VERSION"
            exit 1
          fi
          
          if [ "$DB_SOURCE" = "downloaded" ]; then
            echo "âœ… Migration verified: v${{ inputs.base_db_version || '8' }} â†’ v$ACTUAL_VERSION"
          else
            echo "âœ… Fresh DB created at v$ACTUAL_VERSION (no migration needed)"
          fi

      # Run migration validation tests
      - name: Run migration tests
        working-directory: madara
        run: |
          echo "ðŸ§ª Running migration validation tests..."
          cargo test -p mc-e2e-tests migration_validation -- --ignored --nocapture
        env:
          MIGRATION_TEST_RPC_URL: "http://localhost:${{ env.MADARA_RPC_PORT }}"

      # Cleanup
      - name: Stop madara
        if: always()
        run: |
          pkill -f "madara.*migration-test" || true
          pkill -f "madara.*base-db-creator" || true
          echo "ðŸ§¹ Cleanup complete"

      # Show logs on failure
      - name: Show madara logs on failure
        if: failure()
        run: |
          echo "ðŸ“‹ Madara logs:"
          cat /tmp/madara.log || echo "No madara logs found"
          echo ""
          echo "ðŸ“‹ Sync logs:"
          cat /tmp/sync.log || echo "No sync logs found"

      # Summary
      - name: Summary
        if: always()
        run: |
          echo "## Migration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **DB Source:** ${{ steps.get-db.outputs.db_source }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Base Version:** ${{ inputs.base_db_version || '8' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Expected Version:** ${{ inputs.expected_db_version || '8' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actual Version:** $(cat ${{ env.MADARA_BASE_PATH }}/.db-version 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
