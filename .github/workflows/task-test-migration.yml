# Migration Testing Workflow
#
# Tests database migrations by:
# 1. Reading versions from .db-versions.yml
# 2. Downloading base DB fixture from GitHub releases
# 3. Running madara (migration executes on startup)
# 4. Verifying migration completed
# 5. Running validation tests

name: Task - Test Migration

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      madara-binary-hash:
        description: "Hash used to retrieve the madara binary artifact"
        required: true
        type: string

jobs:
  migration-test:
    name: Test Migration
    runs-on: blacksmith-4vcpu-ubuntu-2204
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Read versions from .db-versions.yml
        id: versions
        run: |
          BASE_VERSION=$(grep 'base_version:' .db-versions.yml | awk '{print $2}')
          CURRENT_VERSION=$(grep 'current_version:' .db-versions.yml | awk '{print $2}')
          echo "base_version=${BASE_VERSION}" >> $GITHUB_OUTPUT
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "üìä Versions: base=${BASE_VERSION}, current=${CURRENT_VERSION}"

      - name: Download base DB fixture
        run: |
          VERSION="${{ steps.versions.outputs.base_version }}"
          IMAGE="ghcr.io/madara-alliance/db-fixture:v${VERSION}"

          echo "üì¶ Pulling base DB v${VERSION} from ${IMAGE}..."
          mkdir -p /tmp/migration-test

          if ! docker pull "${IMAGE}"; then
            echo "‚ùå Base DB fixture not found!"
            echo "Please run: ./scripts/create-base-db.sh ${VERSION}"
            exit 1
          fi

          # Extract tarball from image (scratch image needs dummy command)
          CONTAINER=$(docker create "${IMAGE}" /bin/true)
          docker cp "${CONTAINER}:/db.tar.gz" /tmp/db.tar.gz
          docker rm "${CONTAINER}"

          tar -xzf /tmp/db.tar.gz -C /tmp/migration-test
          echo "‚úÖ DB version: $(cat /tmp/migration-test/.db-version)"

      - name: Download Madara binary
        uses: actions/download-artifact@v4
        with:
          name: madara-binary-${{ inputs.madara-binary-hash }}
          path: madara/target/release/

      - name: Make binary executable
        run: chmod +x madara/target/release/madara

      - name: Start madara
        run: |
          cd madara
          ./target/release/madara \
            --full \
            --base-path /tmp/migration-test \
            --network mainnet \
            --no-l1-sync \
            --sync-stop-at 50 \
            --rpc-port 9944 --rpc-cors all \
            2>&1 | tee /tmp/madara.log &

          for i in {1..90}; do
            curl -s localhost:9944 -H "Content-Type: application/json" \
              -d '{"jsonrpc":"2.0","method":"starknet_chainId","params":[],"id":1}' \
              >/dev/null 2>&1 && echo "‚úÖ Madara ready" && break
            [ $i -eq 90 ] && { cat /tmp/madara.log; exit 1; }
            sleep 2
          done

      - name: Verify migration
        run: |
          ACTUAL=$(cat /tmp/migration-test/.db-version)
          EXPECTED="${{ steps.versions.outputs.current_version }}"
          BASE="${{ steps.versions.outputs.base_version }}"
          echo "Migration: v${BASE} ‚Üí v${EXPECTED}"
          echo "Actual version: v${ACTUAL}"
          [ "$ACTUAL" = "$EXPECTED" ] || { echo "‚ùå Migration failed!"; exit 1; }
          echo "‚úÖ Migration verified"

      - name: Load env
        uses: ./.github/actions/load-env

      - name: Rust setup
        uses: ./.github/actions/setup-rust
        with:
          rust-version: ${{ env.BUILD_RUST_VERSION }}
          cache-key: madara-${{ runner.os }}

      - name: Run migration tests
        working-directory: madara
        run: cargo test -p mc-e2e-tests migration_validation -- --ignored --nocapture
        env:
          MIGRATION_TEST_RPC_URL: "http://localhost:9944"

      - name: Cleanup
        if: always()
        run: pkill -f madara || true

      - name: Show logs on failure
        if: failure()
        run: cat /tmp/madara.log || true
