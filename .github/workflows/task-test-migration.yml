# Migration Testing Workflow
#
# Tests database migrations by:
# 1. Downloading base DB fixture from GitHub releases
# 2. Running madara (migration executes on startup)
# 3. Verifying migration completed
# 4. Running validation tests
#
# Prerequisite: Base DB fixture must exist at:
#   releases/db-fixtures-v{VERSION}/base-db-v{VERSION}-sepolia.tar.gz

name: Task - Test Migration

on:
  workflow_call:
    inputs:
      base_db_version:
        description: 'Base DB version to migrate from'
        required: false
        type: string
        default: '8'
      expected_db_version:
        description: 'Expected DB version after migration'
        required: false
        type: string
        default: '8'
  workflow_dispatch:
    inputs:
      base_db_version:
        description: 'Base DB version to migrate from'
        required: false
        default: '8'
      expected_db_version:
        description: 'Expected DB version after migration'
        required: false
        default: '8'

jobs:
  migration-test:
    name: Test Migration
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: madara

      - name: Download base DB fixture
        run: |
          VERSION="${{ inputs.base_db_version || '8' }}"
          DB_URL="https://github.com/${{ github.repository }}/releases/download/db-fixtures-v${VERSION}/base-db-v${VERSION}-sepolia.tar.gz"
          
          echo "üì¶ Downloading base DB v${VERSION}..."
          mkdir -p /tmp/migration-test
          
          if ! curl -fsSL "$DB_URL" -o db.tar.gz; then
            echo "‚ùå Base DB fixture not found!"
            echo "Please create and upload the fixture first."
            echo "See: scripts/create-base-db.sh"
            exit 1
          fi
          
          tar -xzf db.tar.gz -C /tmp/migration-test
          echo "‚úÖ DB version: $(cat /tmp/migration-test/.db-version)"

      - name: Build madara
        working-directory: madara
        run: cargo build --release -p madara

      - name: Start madara
        run: |
          cd madara
          ./target/release/madara \
            --base-path /tmp/migration-test \
            --network sepolia --no-l1-sync \
            --rpc-port 9944 --rpc-cors all \
            2>&1 | tee /tmp/madara.log &
          
          for i in {1..90}; do
            curl -s localhost:9944 -H "Content-Type: application/json" \
              -d '{"jsonrpc":"2.0","method":"starknet_chainId","params":[],"id":1}' \
              >/dev/null 2>&1 && echo "‚úÖ Madara ready" && break
            [ $i -eq 90 ] && { cat /tmp/madara.log; exit 1; }
            sleep 2
          done

      - name: Verify migration
        run: |
          ACTUAL=$(cat /tmp/migration-test/.db-version)
          EXPECTED="${{ inputs.expected_db_version || '8' }}"
          echo "Base: ${{ inputs.base_db_version || '8' }} ‚Üí Expected: $EXPECTED ‚Üí Actual: $ACTUAL"
          [ "$ACTUAL" = "$EXPECTED" ] || { echo "‚ùå Migration failed!"; exit 1; }
          echo "‚úÖ Migration verified"

      - name: Run migration tests
        working-directory: madara
        run: cargo test -p mc-e2e-tests migration_validation -- --ignored --nocapture
        env:
          MIGRATION_TEST_RPC_URL: "http://localhost:9944"

      - name: Cleanup
        if: always()
        run: pkill -f madara || true

      - name: Show logs on failure
        if: failure()
        run: cat /tmp/madara.log || true
