# Migration Testing Workflow
#
# This workflow tests database migrations by:
# 1. Downloading a base DB at the minimum supported version
# 2. Running new madara on it (migration runs automatically)
# 3. Verifying migration completed successfully
# 4. Running migration-specific validation tests
#
# Triggers:
# - On PRs that modify migration code
# - Manual dispatch for testing

name: Task - Test Migration

on:
  workflow_call:
    inputs:
      base_db_version:
        description: 'Base DB version to test migration from'
        required: false
        type: string
        default: '8'
      expected_db_version:
        description: 'Expected DB version after migration'
        required: false
        type: string
        default: '8'  # Update when actual migration is added
  workflow_dispatch:
    inputs:
      base_db_version:
        description: 'Base DB version to test migration from'
        required: false
        default: '8'
      expected_db_version:
        description: 'Expected DB version after migration'
        required: false
        default: '8'

env:
  MADARA_RPC_PORT: 9944
  MADARA_BASE_PATH: /tmp/madara-migration-test

jobs:
  migration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: madara

      # Step 1: Download base DB
      - name: Download base DB fixture
        run: |
          echo "üì¶ Downloading base DB v${{ inputs.base_db_version || '8' }}..."
          
          # Try to download from GitHub releases
          DB_URL="https://github.com/${{ github.repository }}/releases/download/db-fixtures-v${{ inputs.base_db_version || '8' }}/base-db-v${{ inputs.base_db_version || '8' }}-sepolia.tar.gz"
          
          mkdir -p ${{ env.MADARA_BASE_PATH }}
          
          if curl -fsSL "$DB_URL" -o base-db.tar.gz; then
            tar -xzf base-db.tar.gz -C ${{ env.MADARA_BASE_PATH }}
            echo "‚úÖ Base DB extracted"
            echo "Current DB version: $(cat ${{ env.MADARA_BASE_PATH }}/.db-version)"
          else
            echo "‚ö†Ô∏è Base DB fixture not found at $DB_URL"
            echo "Creating fresh database for testing..."
            # For initial setup or when fixture doesn't exist, we'll create a fresh DB
            # The migration tests will be skipped if no base DB exists
            echo "SKIP_MIGRATION_TEST=true" >> $GITHUB_ENV
          fi

      # Step 2: Build madara
      - name: Build madara
        working-directory: madara
        run: |
          cargo build --release -p madara

      # Step 3: Start madara (migration runs automatically on startup)
      - name: Start madara
        if: env.SKIP_MIGRATION_TEST != 'true'
        run: |
          echo "üöÄ Starting madara (migration will run if needed)..."
          
          cd madara
          ./target/release/madara \
            --name migration-test \
            --base-path ${{ env.MADARA_BASE_PATH }} \
            --network sepolia \
            --no-l1-sync \
            --rpc-port ${{ env.MADARA_RPC_PORT }} \
            --rpc-cors all \
            2>&1 | tee /tmp/madara.log &
          
          echo "‚è≥ Waiting for madara to be ready..."
          for i in {1..90}; do
            if curl -s "http://localhost:${{ env.MADARA_RPC_PORT }}" \
              -H "Content-Type: application/json" \
              -d '{"jsonrpc":"2.0","method":"starknet_chainId","params":[],"id":1}' \
              > /dev/null 2>&1; then
              echo "‚úÖ Madara is ready (attempt $i)"
              break
            fi
            if [ $i -eq 90 ]; then
              echo "‚ùå Madara failed to start"
              cat /tmp/madara.log
              exit 1
            fi
            sleep 2
          done

      # Step 4: Verify migration completed
      - name: Verify migration
        if: env.SKIP_MIGRATION_TEST != 'true'
        run: |
          EXPECTED_VERSION="${{ inputs.expected_db_version || '8' }}"
          ACTUAL_VERSION=$(cat ${{ env.MADARA_BASE_PATH }}/.db-version)
          
          echo "üìä Migration verification:"
          echo "   Base version: ${{ inputs.base_db_version || '8' }}"
          echo "   Expected version: $EXPECTED_VERSION"
          echo "   Actual version: $ACTUAL_VERSION"
          
          if [ "$ACTUAL_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "‚ùå Migration verification failed!"
            echo "   Expected v$EXPECTED_VERSION, got v$ACTUAL_VERSION"
            exit 1
          fi
          
          echo "‚úÖ Migration verified: v${{ inputs.base_db_version || '8' }} ‚Üí v$ACTUAL_VERSION"

      # Step 5: Run migration validation tests
      - name: Run migration tests
        if: env.SKIP_MIGRATION_TEST != 'true'
        working-directory: madara
        run: |
          echo "üß™ Running migration validation tests..."
          cargo test -p madara-tests migration_validation -- --ignored --nocapture
        env:
          MIGRATION_TEST_RPC_URL: "http://localhost:${{ env.MADARA_RPC_PORT }}"

      # Cleanup
      - name: Stop madara
        if: always()
        run: |
          pkill -f "madara.*migration-test" || true
          echo "üßπ Cleanup complete"

      # Show logs on failure
      - name: Show madara logs on failure
        if: failure()
        run: |
          echo "üìã Madara logs:"
          cat /tmp/madara.log || echo "No logs found"

